---
layout: single
title: "Meta-analysis on Psilocybin for Depression"
output:
  md_document:
    variant: markdown_github
    preserve_yaml: true
---

This document outlines the steps taken to perform a meta-analysis investigating the efficacy of psilocybin for treating depression, using data collated for the SYPRES project.
Full source code is available [here](https://github.com/pennlinc/sypres-docs/blob/main/analysis/psilodep/psilodep-meta-analysis.Rmd).

```{r setup knitr, include=FALSE}

basedir <- "/Users/sps253/Documents/GIT/sypres-docs/"
# basedir <- "/Users/bsevchik/Documents/GitHub/sypres-docs" #for brooke

knitr::opts_knit$set(
  base.dir = basedir,
  base.url = "/"
)
knitr::opts_chunk$set(fig.path = "analysis/psilodep/knitfigs/")

knitr::opts_chunk$set(echo = TRUE)
```

### Load Packages

Next, we load the necessary R packages for data manipulation, meta-analysis, and visualization. Key packages include:
- `readr` and `tidyverse` for data loading and manipulation.
- `meta` and `metafor` for conducting the meta-analysis calculations.
- `esc` for effect size calculation utilities.
- `metapsyTools` for specialized functions designed for psychiatric meta-analyses, particularly handling data formats and running pre-defined analysis pipelines.
- `dmetar` for additional meta-analysis functions and tools.

```{r packages, results='hide', message=FALSE, warning=FALSE}
library(readr)
library(tidyverse)
library(meta)
library(metafor)
library(esc)
library(metapsyTools)
library(dmetar)
library(gt)
```

### Data Loading and Preparation

The raw data is loaded from a CSV file. This dataset contains information extracted from multiple studies.

Some studies report change scores from baseline rather than endpoint scores. To pool these studies with those reporting endpoint means and standard deviations (SDs), we need endpoint SDs for the change score studies. Where these are missing, we impute them.

Specifically, for the MADRS (Montgomery–Åsberg Depression Rating Scale) outcome:
1. We identify studies reporting change scores (`outcome_type == "change"`).
2. For Rosenblat et al. (2024) and Goodwin et al. (2022), endpoint SDs are imputed using the average endpoint SD from the Raison et al. (2023) study arms. We calculate the endpoint mean by adding the mean change to the baseline mean. These rows are marked with `outcome_type = "imsd"` (imputed mean/SD).
3. For Raison et al. (2023) itself, we use the reported endpoint SDs directly and calculate the endpoint means from the change scores and baseline means. These rows retain `outcome_type = "msd"`.

The original dataset is then combined with these new rows containing the calculated/imputed endpoint data.

Finally, we use functions from the `metapsyTools` package (`checkDataFormat` and `checkConflicts`) to ensure the combined data conforms to the expected structure and to identify potential inconsistencies (e.g., differing control group data reported for the same study).

```{r load data and impute changes studies, results=FALSE, message=FALSE}
# Load data
data <- read_csv("/Users/sps253/Documents/GIT/data-depression-psiloctr/data.csv")
#data <- read_csv("/Users/bsevchik/Documents/GitHub/metapsy_psilodep/data.csv")
# after release we will replace this with metapsyData load function

# Check data format with checkDataFormat
checkDataFormat(data)

# Check conflicts with checkConflicts
checkConflicts(data)
```

### Filter Data and Calculate Effect Sizes

Before running the main analysis, we prepare the data further:

1.  **Calculate Effect Sizes:** We use `calculateEffectSizes()` (from `metapsyTools`) to compute Hedges' g (a standardized mean difference, SMD) and its standard error for each study comparison based on the endpoint means, SDs, and sample sizes.
2.  **Filter Data:** We select the specific data points to be included in the primary meta-analysis:
    *   Exclude specific low-dose arms (10 mg psilocybin) if present in multi-arm studies.
    *   Exclude the Krempien (2023) study.
    *   Use `filterPoolingData()` (from `metapsyTools`) to select only rows marked as the primary instrument (`primary_instrument == "1"`) and primary timepoint (`primary_timepoint == "1"`) for each study.
    *   Include only the endpoint data (`outcome_type == "msd"` or `"imsd"`), excluding the original change score data.

The resulting `data_main` dataframe contains the filtered data ready for our main meta-analysis.

```{r filter}

data_main <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover,"1"),
    outcome_type == "msd" | outcome_type == "imsd",
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !Detect(study, "Krempien 2023"),
    !Detect(study, "Carhart-Harris 2021")
  )

```

### Run Primary Meta-Analysis

We now perform the main meta-analysis using the `runMetaAnalysis` function from `metapsyTools`. This function simplifies running standard meta-analytic models.

We specify:
- `which.run = "overall"`: Conducts a random-effects meta-analysis pooling all studies in `data_main`.
- `es.measure = "g"`: Uses the pre-calculated Hedges' g effect sizes.
- `method.tau = "REML"`: Employs the Restricted Maximum Likelihood estimator for the between-study variance (τ²).
- `hakn = TRUE`: Applies the Knapp-Hartung adjustment for significance tests, which is recommended for meta-analyses with a small number of studies.
- Various `*.var` arguments map the columns in `data_main` to the required inputs for the analysis (study labels, arm conditions, sample sizes, etc.).

The results, including the pooled effect size, confidence intervals, heterogeneity statistics, and the meta-analysis model object, are stored in `main_results`.

Finally, a basic forest plot is generated using `meta::forest` to visualize the individual study effect sizes and the overall pooled result. The studies are sorted by year.

```{r primary-meta-analysis, message=FALSE}
main_results <- runMetaAnalysis(data_main, # using pre-filtered data for now

  # specify models to run
  which.run = c("overall", "outliers"),
  which.influence = "overall",
  which.outliers = "overall",

  # specify statistical parameters
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

summary(main_results$model.overall)

meta::forest(
  main_results$model.overall,
  sortvar = main_results$model.overall$data$year,
  layout = "JAMA"
)

```

# Funnel Plot & Egger's Test
```{r eggertest}

eggers.test(main_results$model.overall)

```

```{r funnelplot, message=FALSE, results='hide'}

png(filename = file.path(basedir,"analysis/psilodep/paperfigs/SI_Fig_01.png"), res=315, width=2500, height=1500)
funnel(main_results$model.overall,
       studlab = TRUE, #can also use vector with study labels
       cex.studlab = 0.7, #adjust size of study labels
       cex = 0.7,         #axis tick labels and point size
       cex.axis = 0.7,    #axis number label size
       cex.lab = 0.7,     #axis title (xlab, ylab) size
       cex.main = 0.95,    #main title size
       xlim = c(-3,0.2),
       col = "steelblue",
       pch = 19, #bold solid circle
       bg = "white",
       #ylim = 
       xlab = "Standardized Mean Difference (SMD)",
       ylab = "Standard Error (SE)",
       main = "Funnel Plot of Main Model Continuous Outcomes",
       las = 1
       )
dev.off()

```

![](/analysis/psilodep/paperfigs/SI_Fig_01.png)


```{r forest plot using meta for indesigh, include=FALSE}
summary(main_results)

#grab heterogeneity values
tau2 = main_results$model.overall$tau2
lower_tau2 = main_results$model.overall$lower.tau2
upper_tau2 = main_results$model.overall$upper.tau2
I2 = main_results$model.overall$I2
lower_I2 = main_results$model.overall$lower.I2
upper_I2 = main_results$model.overall$upper.I2
pval = main_results$model.overall$pval.Q

#format heterogeneity text
heterogeneity_text <- sprintf(
  "Heterogeneity: I² = %.2f%% [%.2f%%, %.2f%%], τ² = %.2f [%.2f, %.2f], p = %.3f",
  I2 * 100, lower_I2 * 100, upper_I2 * 100,
  tau2, lower_tau2, upper_tau2,
  pval
)

png(filename = file.path(basedir,"analysis/psilodep/paperfigs/continuous_forest_plot_meta.png"), res = 315, width = 4500, height = 1500)


meta::forest(main_results$model.overall,
  sortvar = main_results$model.overall$data$year,
  leftcols = c("studlab", "n_arm1", "mean_arm1", "sd_arm1", "n_arm2", "mean_arm2", "sd_arm2"),
  leftlabs = c("Study", "N", "Mean", "SD", "N", "Mean", "SD"),
  fontsize = 9,
  col.square = "#000080",
  col.diamond = "#000080",
  col.predict = "gray",
  fontfamily = "Arial",
  colgap.forest = "2cm",
  xlim = c(-4.5, 1.5),
  label.left = "Favors intervention",
  label.right = "Favors control",
  smlab = "SMD"
)

#add heterogeneity text at the bottom
grid::grid.text(
  label = heterogeneity_text,
  x = 0.5,                     # Centered horizontally (normalized coordinates)
  y = unit(1.5, "lines"),      # Slightly below the plot
  just = "center",
  gp = grid::gpar(fontsize = 9, fontfamily = "Arial")
)

dev.off()
```


# three-level CHE
```{r che, message=FALSE}

data_time <- data %>%
  calculateEffectSizes() %>%
  filter(
    is.na(multi_arm1) | !str_detect(multi_arm1, "10 mg"),
    is.na(multi_arm2) | !str_detect(multi_arm2, "10 mg"),
    !str_detect(study, "Krempien 2023"),
    !str_detect(study, "Carhart-Harris 2021")
  ) %>%
  filterPoolingData(
    primary_instrument == "1",
    time_days > 0,
    post_crossover == 0 | is.na(post_crossover),
    outcome_type == "msd" | outcome_type == "imsd"
  )

time_results <- runMetaAnalysis(data_time, # using pre-filtered data for now
  
  which.run = "threelevel.che",
  # specify statistical parameters
  es.measure = "g", # uses .g column in data and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_days",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

time_results$model.threelevel.che

```

```{r meta-regression, message=FALSE, warning=FALSE}

reg <- metaRegression(time_results$model.threelevel.che, ~ time_days)
reg

```

```{r plot-meta-regression, message=FALSE, warning=FALSE, results=FALSE}

png(filename = file.path(basedir,"analysis/psilodep/paperfigs/SI_Fig_02.png"), res=315, width=3000, height=2200)
regplot(reg, mod="time_days", xlab="Time since final dose (days)")
dev.off()

```

![](/analysis/psilodep/paperfigs/SI_Fig_02.png)



### Subgroup & sensitivity analyses! 
Subgroups analyses can be easily filtered. We can run them all at once with 
metapsyTools by mutating the the `multi_arm2` variable to be a dummy variable 
designating our subgroups.

```{r subgroup-and-sensitivity-data-filtering}

# Build a dataframe that has each subgroup and sensitivity analysis in it

data_main <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover,"1"),
    outcome_type == "msd" | outcome_type == "imsd",
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !Detect(study, "Krempien 2023"),
    !Detect(study, "Carhart-Harris 2021")
    ) %>%
    mutate(multi_arm2 = "main")

data_dep <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover,"1"),
    outcome_type == "msd" | outcome_type == "imsd",
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !Detect(study, "Krempien 2023"),
    !Detect(study, "Carhart-Harris 2021"),
    diagnosis == "dep" | diagnosis == "trd"
    ) %>%
    mutate(multi_arm2 = "dep")

data_excwl <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover,"1"),
    outcome_type == "msd" | outcome_type == "imsd",
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !Detect(study, "Krempien 2023"),
    !Detect(study, "Carhart-Harris 2021"),
    outcome_type == "msd" | outcome_type == "imsd",
    !Detect(condition_arm2, "wl"),
  ) %>%
  mutate(multi_arm2 = "excwl")

data_rob <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover,"1"),
    outcome_type == "msd" | outcome_type == "imsd",
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !Detect(study, "Krempien 2023"),
    !Detect(study, "Carhart-Harris 2021"),
    outcome_type == "msd" | outcome_type == "imsd",
    !Detect(rob, "High"),
  ) %>%
  mutate(multi_arm2 = "rob")

data_parallel <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    outcome_type == "msd" | outcome_type == "imsd",
    is.na(post_crossover) | !Detect(post_crossover,"1"),
    outcome_type == "msd" | outcome_type == "imsd",
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !Detect(study, "Krempien 2023"),
    !Detect(study, "Carhart-Harris 2021"),
    design == "parallel"
  ) %>%
  mutate(multi_arm2 = "parallel")

data_crossover <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    outcome_type == "msd" | outcome_type == "imsd",
    is.na(post_crossover) | !Detect(post_crossover,"1"),
    outcome_type == "msd" | outcome_type == "imsd",
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !Detect(study, "Krempien 2023"),
    !Detect(study, "Carhart-Harris 2021"),
    design == "crossover"
  ) %>%
  mutate(multi_arm2 = "crossover")

data_expanded <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    outcome_type == "msd" | outcome_type == "imsd",
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !(Detect(study, "Krempien 2023") & (!is.na(multi_arm1)) & Detect(multi_arm1, "12 mg")),
    !(Detect(study, "Krempien 2023") & (!is.na(multi_arm2)) & Detect(multi_arm2, "12 mg"))
    ) %>%
    mutate(multi_arm2 = "expanded")

data_outliers <- data_main %>%
  filterPoolingData(
    !Detect(study, "Davis 2021")
    ) %>%
    mutate(multi_arm2 = "outliers")

data_fixed <- data_main %>%
    mutate(multi_arm2 = "fixed")

data_g10 <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover,"1"),
    outcome_type == "msd" | outcome_type == "imsd",
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "25 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "25 mg")),
    !Detect(study, "Krempien 2023"),
    !Detect(study, "Carhart-Harris 2021")
    )  %>%
    mutate(multi_arm2 = "g10")

data_clinician <- data %>%
  filterPoolingData(
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover,"1"),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !Detect(study, "Krempien 2023"),
    !Detect(study, "Carhart-Harris 2021"),
    rating == "clinician",
    Detect(instrument_symptom, "depression"),
    outcome_type != "response",
    outcome_type != "remission",
    outcome_type != "change"
  ) %>%
  mutate(multi_arm2 = "clincian") %>%
  filterPriorityRule(instrument = c("madrs", "grid-ham-d"))

data_selfreport <- data %>%
  filterPoolingData(
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover,"1"),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !Detect(study, "Krempien 2023"),
    !Detect(study, "Carhart-Harris 2021"),
    rating == "self-report",
    Detect(instrument_symptom, "depression"),
    outcome_type != "response",
    outcome_type != "remission",
    outcome_type != "change" & outcome_type != "unknown"
  ) %>%
  mutate(multi_arm2 = "self-report") %>%
  filterPriorityRule(instrument = c("bdi", "qids-sr", "hads-d", "smdds", "hads"))


```



```{r bind subgroup data, include=FALSE}
data_all <- bind_rows(
  data_main,
  data_dep,
  data_excwl,
  data_rob,
  data_parallel,
  data_crossover,
  data_expanded,
  data_outliers,
  data_fixed,
  data_g10,
  data_clinician,
  data_selfreport,
)

```



```{r subgroup analysis easy, include=FALSE}
m <- runMetaAnalysis(data_all,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_days",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

# Run a subgroup analysis
m.sg <- subgroupAnalysis(m, multi_arm2)

# Extract the subgroup analysis model for "multi_arm2"
# This gives you complete flexibility regarding the forest plot
# All meta::forest arguments can be passed
m.sg$subgroup.analysis.list$multi_arm2 -> m.sg.ma2

png(filename = file.path(basedir,"analysis/psilodep/paperfigs/stacked_subgroup_plots.png"), res=315, width=2750, height=9000)

meta::forest(m.sg.ma2,
  sortvar = m.sg.ma2$data$year,
  col.square = "lightblue",
  col.predict = "black",
  fontfamily = "Arial"
)

dev.off()

```



```{r run individual meta analyses for paper, warning=FALSE, message=FALSE}
main <- runMetaAnalysis(data_main,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

# use metapsyTools replacement and rerun functions for quickly repeating the same analysis with the same parameters

dep <- main # copy the model to a new name
data(dep) <- data_dep # replace the dataframe in the new model
rerun(dep) # re-run the model

excwl <- main
data(excwl) <- data_excwl
rerun(excwl)

rob <- main
data(rob) <- data_rob
rerun(rob)

parallel <- main
data(parallel) <- data_parallel
rerun(parallel)

crossover <- main
data(crossover) <- data_crossover
rerun(crossover)

### SENSITIVITY

expanded <- main
data(expanded) <- data_expanded
rerun(expanded)

outliers <- main
data(outliers) <- data_outliers
rerun(outliers)

fixed <- main
method.tau(fixed) <- "FE" # for this sensitivity analysis, we keep data the same but change parameters
hakn(fixed) <- FALSE
rerun(fixed)

g10 <- main
data(g10) <- data_g10
rerun(g10)

clinician <- main
data(clinician) <- data_clinician
rerun(clinician)

selfreport <- main
data(selfreport) <- data_selfreport
rerun(selfreport)

```
```{r rerun FULL models to be able to create figure, include=FALSE}

main <- runMetaAnalysis(data_main,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

dep <- runMetaAnalysis(data_dep,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

excwl <- runMetaAnalysis(data_excwl,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

rob <- runMetaAnalysis(data_rob,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

parallel <- runMetaAnalysis(data_parallel,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

crossover <- runMetaAnalysis(data_crossover,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

expanded <- runMetaAnalysis(data_expanded,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

outliers <- runMetaAnalysis(data_outliers,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

fixed <- runMetaAnalysis(data_main, # using pre-filtered data for now

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "FE", # fixed effects
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = FALSE, # set to false for FE

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "study_time_point",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

g10 <- runMetaAnalysis(data_g10,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

clinician <- runMetaAnalysis(data_clinician,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

selfreport <- runMetaAnalysis(data_selfreport,

  # specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # uses .g column in data_es and .g_se (Hedges' g/bias-corrected SMD)
  method.tau = "REML", # default, but still including for clarity
  method.tau.ci = "Q-Profile", # not sure if this will work!
  hakn = TRUE, # Knapp-Hartung effect size significance tests be used

  # specify variables in data_es
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2 # can change to change number of digits to round the presented results to
)

```

```{r create subgroup and sensitivity analysis summary table, include=FALSE}
# Helper to parse CI from string to numeric
parse_ci <- function(ci_string) {
  nums <- str_extract_all(ci_string, "-?\\d+\\.?\\d*")[[1]]
  as.numeric(nums)
}

# Function for one-row summary objects (like goodwin10_results)
extract_subgroup_summary <- function(obj, label) {
  s <- obj$summary
  ci <- parse_ci(s$g.ci)
  i2_ci <- parse_ci(s$i2.ci)

  tibble(
    subgroup = label,
    hedges_g = s$g,
    lower_ci = ci[1],
    upper_ci = ci[2],
    pval = as.numeric(s$p),
    tau2 = obj$model.overall$tau2,
    N_studies = s$k,
    I2 = s$i2,
    lower_i2_ci = i2_ci[1],
    upper_i2_ci = i2_ci[2]
  )
}



# Build combined summary table
full_subgroup_summary <- bind_rows(
  #subgroup
  extract_subgroup_summary(main, "Main model"),
  extract_subgroup_summary(dep, "Depression as primary diagnosis"),
  extract_subgroup_summary(parallel, "Parallel design"),
  extract_subgroup_summary(crossover, "Crossover design"),
  extract_subgroup_summary(excwl, "Exclude open-label"),
  extract_subgroup_summary(rob, "Exclude high RoB"),
  #sensitivity
  extract_subgroup_summary(g10, "Alternate dosing in Goodwin et al"),
  extract_subgroup_summary(expanded, "Expanded inclusion criteria"),
  extract_subgroup_summary(clinician, "Clinician-rated outcomes"),
  extract_subgroup_summary(selfreport, "Self-report outcomes"),
  extract_subgroup_summary(outliers, "Excluding outliers"),
  extract_subgroup_summary(fixed, "Fixed Effects model")
)

print(full_subgroup_summary)


```


```{r make forest plot with ggplot 5, subgroup - fixed ratio, include=FALSE}

## Create the forest plot!
#To edit spacing/sizing:
#-Adjusting the width and height of how you save out ggplot will change spacing for forest plot. It's easier to change the row spacing of the table to match.
#-line with data_row.padding, can be adjusted to increase or decrease the spacing of the rows in the table to match the spacing of the rows in the forest plot
#-If changing image size results in blurry png, then use the zoom argument in gtsave at the end to increase clarity of text


library(ggplot2)
library(dplyr)
library(forcats)
library(tidyr)
library(purrr)
library(webshot2)


# Prepare data
desired_order <- c("Main model",
                   "Depression as primary diagnosis",
                   "Exclude open-label",
                   "Exclude high RoB",
                   "Parallel design",
                   "Crossover design",
                   "Expanded inclusion criteria",
                   "Excluding outliers",
                   "Fixed Effects model",
                   "Alternate dosing in Goodwin et al",
                   "Clinician-rated outcomes",
                   "Self-report outcomes"
                   )

full_subgroup_summary <- full_subgroup_summary %>%
  mutate(
    subgroup = factor(subgroup, levels = desired_order),
    color = if_else(subgroup == "Main model", "Main", "Other"),
    row = as.numeric(fct_rev(subgroup))
  )


# Function to create diamond polygon coordinates
make_diamond <- function(xmid, xmin, xmax, ymid, height = 0.25) {
  tibble(
    x = c(xmid, xmax, xmid, xmin),
    y = c(ymid + height, ymid, ymid - height, ymid)
  )
}

# Build diamonds
diamond_df <- full_subgroup_summary %>%
  mutate(diamond = pmap(list(hedges_g, lower_ci, upper_ci, row), make_diamond)) %>%
  select(subgroup, diamond, color) %>%
  unnest(diamond)

# Plot using numeric y-position
subgroup_plot <- ggplot(full_subgroup_summary, aes(x = hedges_g, y = row)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  geom_polygon(
    data = diamond_df,
    aes(x = x, y = y, group = subgroup, fill = color),
    alpha = 0.3,
    color = NA
  ) +
  geom_point(aes(color = color), shape = 15, size = 3) +
  geom_errorbarh(aes(xmin = lower_ci, xmax = upper_ci, color = color), height = 0.2) +
  scale_x_continuous(
    limits = c(-3, 1),
    breaks = seq(-3, 1, by = 1),
    expand = c(0,0), #removes extra x axis at the ends
    name = "Hedges' g (95% CI)"
  ) +
  scale_y_continuous(
    breaks = full_subgroup_summary$row,
    labels = full_subgroup_summary$subgroup
  ) +
  scale_color_manual(values = c("Main" = "#000080", "Other" = "forestgreen")) +
  scale_fill_manual(values = c("Main" = "#000080", "Other" = "forestgreen")) +
  labs(
    x = "Hedges' g (95% CI)",
    y = "Subgroup",
    title = "Subgroup Meta-Analysis Summary"
  ) +
  theme(
    text = element_text(family = "Arial"),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    panel.grid = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_blank(),
    axis.ticks = element_line(color = "black"),
    axis.ticks.length = unit(7, "pt"),
    legend.position = "none",
    axis.text = element_text(size = 14), #change font size
    axis.title.x =element_text(size = 14), #change font size
    plot.title = element_text(size = 14, face = "bold")
  )

subgroup_plot
ggsave(file.path(basedir,"analysis/psilodep/paperfigs/subgroup_forest_ggplot.png"),
  plot = subgroup_plot, width = 10, height = 8, dpi = 300
)


###BELOW IS CODE FOR TABLE PART OF PLOT

# Create required table_df from full_sensitivity_summary
table_subgroup_df <- full_subgroup_summary %>%
  mutate(
    `95% CI` = paste0("[", round(lower_ci, 2), ", ", round(upper_ci, 2), "]"),
    #`Tau²` = round(tau2, 2),
    `Tau²` = formatC(signif(tau2, 2), format = "fg", digits = 2, flag = "#"),
    `Hedges' g` = round(hedges_g, 2),
    N = N_studies
  ) %>%
  select(
    Subgroup = subgroup,
    N,
    `Tau²`,
    `Hedges' g`,
    `95% CI`
  ) %>%
  mutate(Subgroup = factor(Subgroup, levels = desired_order)) %>%
  arrange(Subgroup)
table_subgroup_df

# Order of rows
table_subgroup_df <- table_subgroup_df %>%
  mutate(Subgroup = factor(Subgroup, levels = desired_order)) %>%
  arrange(Subgroup)

# Create a styled gt table
subgroup_table <- table_subgroup_df %>%
  gt() %>%
  tab_header(title = md("**Meta-Analysis Subgroup Summary**")) %>%
  cols_label(
    Subgroup = "Subgroup",
    N = "N",
    `Tau²` = html("&tau;<sup>2</sup>"),
    `Hedges' g` = html("Hedges' *g*"),
    `95% CI` = "95% CI"
  ) %>%
  opt_table_font(font = list(gt::google_font("Arial"))) %>%
  tab_options(
    data_row.padding = px(2.36),  # HERE control row spacing to match graph!
    table_body.hlines.style = "none",
    row.striping.include_table_body = FALSE,
    table_body.border.top.style = "none",
    table_body.border.bottom.style = "none",
    column_labels.border.bottom.style = "solid",
    table.font.size = 2.7 #change font size
  ) %>%
  cols_align(align = "left", columns = everything())

gtsave(subgroup_table, filename = file.path(basedir,"analysis/psilodep/paperfigs/subgroup_table.png"), vwidth = 2000, vheight = 1200, zoom = 10) #setting Zoom higher makes image less blurry/clearer



```

Here's our summary figure!
![](/analysis/psilodep/paperfigs/Fig_03.png)

### Run Meta-Analyses on Dichotomous Data


filter for response and remission data
```{r load data}

data_response <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    outcome_type == "response",
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !Detect(study, "Krempien 2023")
  )
data_response <- data_response[order(data_response$year), ]

data_remission <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    outcome_type == "remission",
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm1)) & Detect(multi_arm1, "10 mg")),
    !(Detect(study, "Goodwin 2022") & (!is.na(multi_arm2)) & Detect(multi_arm2, "10 mg")),
    !Detect(study, "Krempien 2023")
  )
data_remission <- data_remission[order(data_remission$year), ]

```


run meta-analysis on response data
```{r response model, message=FALSE}

response_results <- runMetaAnalysis(data_response,
  which.run = "overall",
  es.measure = "RR", # risk ratio
  es.type = "raw",
  method.tau = "PM",
  method.tau.ci = "Q-Profile",
  method.random.ci = "HK",
  hakn = TRUE, # Knapp-Hartung adjustement

  # specify variables in data_dichotomous
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2
)

meta::forest(
  response_results$model.overall,
  sortvar = response_results$model.overall$data$year,
  xlab = "Log RR (95% CI)",
  leftlabs = c("Study", "Log RR"),
  layout = "JAMA")
```


run meta-analysis for remission data
```{r remission model, message=FALSE}
remission_results <- runMetaAnalysis(data_remission,
  which.run = "overall",
  es.measure = "RR", # risk ratio
  es.type = "raw",
  method.tau = "PM",
  method.tau.ci = "Q-Profile",
  method.random.ci = "HK",
  hakn = TRUE, # Knapp-Hartung adjustement

  # specify variables in data_dichotomous
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2
)

meta::forest(
  remission_results$model.overall,
  sortvar=remission_results$model.overall$data$year,
  xlab = "Log RR (95% CI)",
  leftlabs = c("Study", "Log RR"),
  layout = "JAMA")

```


```{r forest meta response for indesign, include=FALSE}
###forest plot for response

#grab heterogeneity values
tau2 = response_results$model.overall$tau2
lower_tau2 = response_results$model.overall$lower.tau2
upper_tau2 = response_results$model.overall$upper.tau2
I2 = response_results$model.overall$I2
lower_I2 = response_results$model.overall$lower.I2
upper_I2 = response_results$model.overall$upper.I2
pval = response_results$model.overall$pval.Q

#format heterogeneity text
heterogeneity_text <- sprintf(
  "Heterogeneity: I² = %.2f%% [%.2f%%, %.2f%%], τ² = %.2f [%.2f, %.2f], p = %.3f",
  I2 * 100, lower_I2 * 100, upper_I2 * 100,
  tau2, lower_tau2, upper_tau2,
  pval
)

png(filename = file.path(basedir,"analysis/psilodep/paperfigs/response_forest_plot_meta.png"), res=315, width=4500, height=1500)


meta::forest(response_results$model.overall,
             sortvar = response_results$mode.overall$data$year,
             leftcols = c("studlab", "event_arm1", "totaln_arm1", "event_arm2", "totaln_arm2"),
             leftlabs = c("Study", "Number of Events", "Total", "Number of Events", "Total"),
             rightlabs = c("Log RR", "95%-CI", "Weight"),
             fontsize = 9,
             col.square = "#000080",
             col.diamond = "#000080",
             col.predict = "gray",
             fontfamily = "Arial",
             colgap.forest = "2cm",
             xlim = c(0.5, 25),
             label.left = "Favors control",
             label.right = "Favors intervention",
             smlab = "Log Risk Ratio")

#add heterogeneity text at the bottom
grid::grid.text(
  label = heterogeneity_text,
  x = 0.5,                     # Centered horizontally (normalized coordinates)
  y = unit(1.5, "lines"),      # Slightly below the plot
  just = "center",
  gp = grid::gpar(fontsize = 9, fontfamily = "Arial")
)

dev.off()
```

```{r forest meta remission for indesign, include=FALSE}
###forest plot for remission

#grab heterogeneity values
tau2 = remission_results$model.overall$tau2
lower_tau2 = remission_results$model.overall$lower.tau2
upper_tau2 = remission_results$model.overall$upper.tau2
I2 = remission_results$model.overall$I2
lower_I2 = remission_results$model.overall$lower.I2
upper_I2 = remission_results$model.overall$upper.I2
pval = remission_results$model.overall$pval.Q

#format heterogeneity text
heterogeneity_text <- sprintf(
  "Heterogeneity: I² = %.2f%% [%.2f%%, %.2f%%], τ² = %.2f [%.2f, %.2f], p = %.3f",
  I2 * 100, lower_I2 * 100, upper_I2 * 100,
  tau2, lower_tau2, upper_tau2,
  pval
)

png(filename = file.path(basedir,"analysis/psilodep/paperfigs/remission_forest_plot_meta.png"), res=315, width=4500, height=1500)


meta::forest(remission_results$model.overall,
             sortvar = remission_results$model.overall$data$year,
             leftcols = c("studlab", "event_arm1", "totaln_arm1", "event_arm2", "totaln_arm2"),
             leftlabs = c("Study", "Number of Events", "Total", "Number of Events", "Total"),
             rightlabs = c("Log RR", "95%-CI", "Weight"),
             fontsize = 9,
             col.square = "#000080",
             col.diamond = "#000080",
             col.predict = "gray",
             fontfamily = "Arial",
             colgap.forest = "2cm",
             xlim = c(0.5, 25),
             label.left = "Favors control",
             label.right = "Favors intervention",
             smlab = "Log Risk Ratio")

#add heterogeneity text at the bottom
grid::grid.text(
  label = heterogeneity_text,
  x = 0.5,                     # Centered horizontally (normalized coordinates)
  y = unit(1.5, "lines"),      # Slightly below the plot
  just = "center",
  gp = grid::gpar(fontsize = 9, fontfamily = "Arial")
)

dev.off()

```



```{r runmetaAnalysis on fixed response results, include=FALSE}
#run fixed meta-analysis on response results
fixed_response_results <- runMetaAnalysis(data_response,
  which.run = "overall",
  es.measure = "RR", # risk ratio
  es.type = "raw",
  method.tau = "FE",
  method.tau.ci = "Q-Profile",
  method.random.ci = "HK",
  hakn = FALSE, # Knapp-Hartung adjustement

  # specify variables in data_dichotomous
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "study_time_point",
  round.digits = 2
)
fixed_response_results
```

```{r runmetaAnalysis on fixed remission results, include=FALSE}
#run fixed meta-analysis on remission results

fixed_remission_results <- runMetaAnalysis(data_remission,
  which.run = "overall",
  es.measure = "RR", # risk ratio
  es.type = "raw",
  method.tau = "FE",
  method.tau.ci = "Q-Profile",
  method.random.ci = "HK",
  hakn = FALSE, # Knapp-Hartung adjustement

  # specify variables in data_dichotomous
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "study_time_point",
  round.digits = 2
)
fixed_remission_results
```




