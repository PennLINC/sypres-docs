---
layout: single
title: "Reproducibility Guide: Meta-analysis on MDMA for PTSD"
output:
  md_document:
    variant: markdown_github
    preserve_yaml: true
---

# XXX: update these paths/desciptions
This document provides a comprehensive walk-through of the meta-analysis investigating the efficacy of MDMA for treating PTSD symptoms, using data extracted for the SYPRES project.
The analysis includes both continuous (PTSD symptom severity scores) and dichotomous (response/remission rates) outcomes, along with extensive subgroup and sensitivity analyses.

Our database for this analysis can be accessed through the R package `metapsyData`.
It can also be downloaded directly as a CSV file [here](https://github.com/metapsy-project/data-ptsd-mdmactr/blob/master/data.csv).
Documentation on `metapsyData` is available [here](https://data.metapsy.org).

The meta-analytic portion of this script primarily uses the R package `metapsyTools`.
Documentation on `metapsyTools` is available [here](https://tools.metapsy.org).

This walk-through has some code chunks hidden for clarity.
Full source code for this analysis is available [here](https://github.com/pennlinc/sypres-docs/blob/main/analysis/mdmaptsd/mdmaptsd-meta-analysis.Rmd).

## Overview

This meta-analysis synthesizes evidence from randomized controlled trials examining the efficacy of MDMA for treating PTSD.
The analysis employs meta-analytic methods to provide robust estimates of treatment effects while accounting for study heterogeneity and potential biases.

### Key Features of This Analysis

- **Comprehensive outcome assessment**: Both continuous (PTSD symptom severity) and dichotomous (response/remission) outcomes
- **Time course analysis**: Three-level hierarchical models to examine treatment effects over time
- **Robustness testing**: Extensive sensitivity and subgroup analyses
- **Publication bias assessment**: Multiple methods to evaluate potential bias
- **Transparent reporting**: Complete code and methodology documentation

## Methods

### Key statistical specifications:

- **Effect size**: Hedges' g for continuous outcomes, log RR for dichotomous outcomes
- **Heterogeneity estimator**: REML for random-effects models
- **Confidence intervals**: Q-Profile method for heterogeneity, Knapp-Hartung adjustment for effect sizes
- **Significance testing**: Knapp-Hartung adjustment for small sample sizes

### Quality Assessment

We conduct sensitivity analyses excluding studies with high risk of bias evaluated using the Cochrane Risk of Bias tool.
Publication bias is evaluated using a funnel plot and Egger's test.

```{r setup knitr, include=FALSE}
#basedir <- "/Users/sps253/Documents/GIT/sypres-docs/" # for parker
basedir <- "/Users/bsevchik/Documents/GitHub/sypres-docs" # for brooke

knitr::opts_knit$set(
  base.dir = basedir,
  base.url = "/"
)
knitr::opts_chunk$set(fig.path = "analysis/mdmaptsd/knitfigs/")

knitr::opts_chunk$set(echo = TRUE)
```

### Load Required Packages

We begin by loading the necessary R packages for data manipulation, meta-analysis, and visualization:

- **Data manipulation**: `readr` and `tidyverse` for data loading and manipulation
- **Meta-analysis**: `meta` and `metafor` for conducting meta-analytic calculations
- **Effect sizes**: `esc` for effect size calculation utilities
- **Specialized tools**: `metapsyTools` for specific meta-analysis functions and `dmetar` for additional meta-analysis tools

```{r packages, results='hide', message=FALSE, warning=FALSE}
library(readr)
library(tidyverse)
library(meta)
library(metafor)
library(metapsyTools)
library(metapsyData)
library(gt)
library(dmetar)
library(bayesmeta)
```

### Data Loading and Quality Checks

The sypres database `ptsd-mdmactr` is downloaded using the `metapsyData` package.
Before proceeding with the analysis, we perform quality checks to ensure data integrity and identify potential issues.

```{r load data, results=FALSE, message=FALSE}
# # Load data using metapsyData
# d <- getData("ptsd-mdmactr")
# data <- d$data
# 
# 
# # Check data format with checkDataFormat
# checkDataFormat(data)
# 
# # Check conflicts with checkConflicts
# checkConflicts(data,
#   vars.for.id = c(
#     "study", "outcome_type",
#     "instrument", "study_time_point",
#     "time_weeks",
#     "rating"
#   )
# )
#data<-read_csv("~/Documents/GIT/psypres/MDMAPTSD/data/data.csv") #for parker
data<-read_csv("/Users/bsevchik/Documents/GitHub/psypres/MDMAPTSD/data/data.csv") #for brooke
data <- data %>%
  calculateEffectSizes(
    vars.for.id = c(
      "study", "outcome_type",
      "instrument", "study_time_point",
      "time_weeks",
      "rating"
    ),
  )

# Check data format with checkDataFormat
checkDataFormat(data)

# Check conflicts with checkConflicts
checkConflicts(data,
  vars.for.id = c(
    "study", "outcome_type",
    "instrument", "study_time_point",
    "time_weeks",
    "rating"
  )
)
```

### Data Preparation and Filtering

We prepare the data for analysis by applying several filters to create our primary analysis dataset:

1. **Primary outcomes**: Select only the primary instrument and timepoint for each study
2. **Study design**: Exclude post-crossover data to avoid double-counting
3. **Outcome type**: Include only endpoint data (mean/SD or imputed mean/SD)
4. **Dosing**: Exclude medium-dose arm (10 mg MDMA) from multi-arm study (Goodwin 2022)
5. **Study exclusions**: Remove specific studies (Grob 2011, Krempien 2023, Carhart-Harris 2021) based on predefined criteria

The resulting `data_main` dataframe contains the filtered data ready for our primary meta-analysis.

```{r filter}
# data_main <- data %>%
#   filterPoolingData(
#     primary_instrument == "1",
#     primary_timepoint == "1",
#     is.na(post_crossover) | !Detect(post_crossover, "1"),
#     outcome_type == "msd",
#     !(Detect(study, "Mithoefer 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "75 mg")),
#     !(Detect(study, "Ot'alora 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "100 mg"))
#   )

data_main <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover, "1"),
    outcome_type == "msd",
    !(Detect(study, "Mithoefer 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "75 mg")),
    !(Detect(study, "Mithoefer 2018") & (Detect(multi_arm1, "75 mg") & !is.na(multi_arm2))),
    !(Detect(study, "Ot'alora 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "100 mg")),
    !(Detect(study, "Ot'alora 2018") & (Detect(multi_arm1, "100 mg") & !is.na(multi_arm2)))
  )

data_time <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    post_crossover == 0 | is.na(post_crossover),
    is.na(post_crossover) | !Detect(post_crossover, "1"),
    outcome_type == "msd",
    !(Detect(study, "Mithoefer 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "75 mg")),
    !(Detect(study, "Ot'alora 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "100 mg"))
  )

# data_time <- data %>%
#   filterPoolingData(
#     primary_instrument == "1",
#     post_crossover == 0 | is.na(post_crossover),
#     is.na(post_crossover) | !Detect(post_crossover, "1"),
#     outcome_type == "msd",
#     !(Detect(study, "Mithoefer 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "75 mg")),
#     !(Detect(study, "Ot'alora 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "100 mg")),
#     !(Detect(study, "Mithoefer 2011") & Detect(cov_time_point,"Follow-up 1"))
#   )

data_response <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover, "1"),
    outcome_type == "response",
    !(Detect(study, "Mithoefer 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "75 mg")),
    !(Detect(study, "Mithoefer 2018") & (Detect(multi_arm1, "75 mg") & !is.na(multi_arm2))),
    !(Detect(study, "Ot'alora 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "100 mg")),
    !(Detect(study, "Ot'alora 2018") & (Detect(multi_arm1, "100 mg") & !is.na(multi_arm2)))
  )

data_remission <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover, "1"),
    outcome_type == "remission",
    !(Detect(study, "Mithoefer 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "75 mg")),
    !(Detect(study, "Mithoefer 2018") & (Detect(multi_arm1, "75 mg") & !is.na(multi_arm2))),
    !(Detect(study, "Ot'alora 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "100 mg")),
    !(Detect(study, "Ot'alora 2018") & (Detect(multi_arm1, "100 mg") & !is.na(multi_arm2)))
  )

data_depression <- data %>%
  filterPoolingData(
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover, "1"),
    !(Detect(study, "Mithoefer 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "75 mg")),
    !(Detect(study, "Mithoefer 2018") & (Detect(multi_arm1, "75 mg") & !is.na(multi_arm2))),
    !(Detect(study, "Ot'alora 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "100 mg")),
    !(Detect(study, "Ot'alora 2018") & (Detect(multi_arm1, "100 mg") & !is.na(multi_arm2))),
    Detect(instrument_symptom, "depression"),
    outcome_type == "msd"
  ) %>%
  filterPriorityRule(instrument = c("bdi-ii", "bid-1a", "bdi", "qids-sr", "hads-d", "smdds", "hads"))

data_sleep <- data %>%
  filterPoolingData(
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover, "1"),
    !(Detect(study, "Mithoefer 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "75 mg")),
    !(Detect(study, "Mithoefer 2018") & (Detect(multi_arm1, "75 mg") & !is.na(multi_arm2))),
    !(Detect(study, "Ot'alora 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "100 mg")),
    !(Detect(study, "Ot'alora 2018") & (Detect(multi_arm1, "100 mg") & !is.na(multi_arm2))),
    Detect(instrument_symptom, "sleep"),
    outcome_type == "msd"
  )

data_medium_dose <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover, "1"),
    outcome_type == "msd",
    !(Detect(study, "Mithoefer 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "125 mg")),
    !(Detect(study, "Mithoefer 2018") & (Detect(multi_arm1, "125 mg") & !is.na(multi_arm2))),
    !(Detect(study, "Ot'alora 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "125 mg")),
    !(Detect(study, "Ot'alora 2018") & (Detect(multi_arm1, "125 mg") & !is.na(multi_arm2)))
  )
```

## Results

### Primary Meta-Analysis

We conduct the main meta-analysis using the `runMetaAnalysis` function from `metapsyTools`.
This analysis pools all studies in our filtered dataset to estimate the overall effect of MDMA on PTSD severity.

**Key specifications:**

- **Effect size**: Hedges' g (standardized mean difference)

- **Model**: Random-effects meta-analysis using REML estimator

- **Adjustments**: Knapp-Hartung adjustment for significance tests

- **Additional analyses**: Outlier detection and removal


The results include the pooled effect size, confidence intervals, heterogeneity statistics, and the meta-analysis model object.

```{r primary-meta-analysis, message=FALSE}
# Run meta-analysis

main_results <- runMetaAnalysis(data_main,
  which.run = c("overall"),
  # Specify statistical parameters
  es.measure = "g", # Hedges' g
  method.tau = "REML",
  method.tau.ci = "Q-Profile", # N/A for three-level models
  # i2.ci.boot = TRUE, # Need to use bootstrapping to get het. CI on three-level
  hakn = TRUE, # Knapp-Hartung adjustment

  # Specify variables
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_days",
  round.digits = 2
)

summary(main_results$model.overall)

# Create simple forest plot of results

plot(
  main_results,
  which = "overall"
)
```


The primary meta-analysis on continuous outcomes in the 6 studies included in the main model showed a statistically significant reduction in PTSD scores with MDMA treatment as compared to control conditions, with small between-study heterogeneity.

```{r main continuous forest plot for indesign, include=FALSE}
png(filename = file.path(basedir, "analysis/mdmaptsd/paperfigs/fig2_mdmaptsd.png"), res = 315, width = 4500, height = 1500)

# plot(
#   main_results,
#   which = "overall",
#   leftcols = c("studlab", "condition_arm1", "dose_arm1", "n_arm1", "mean_arm1", "sd_arm1", "condition_arm2", "dose_arm2", "n_arm2", "mean_arm2", "sd_arm2"),
#   leftlabs = c("Study", "Drug", "Dose", "N", "Mean","SD", "Drug", "Dose", "N", "Mean", "SD"),
#   fontsize = 9,
#   col.square = "#000080",
#   col.diamond = "#000080",
#   col.predict = "gray",
#   fontfamily = "Arial",
#   colgap.forest = "2cm",
#   xlim = c(-4.5, 2),
#   label.left = "Favors intervention",
#   label.right = "Favors control",
#   smlab = "SMD")
meta::forest(main_results$model.overall,
  sortvar = main_results$model.overall$data$year,
  leftcols = c("studlab", "condition_arm1", "dose_arm1", "n_arm1", "mean_arm1", "sd_arm1", "condition_arm2", "dose_arm2", "n_arm2", "mean_arm2", "sd_arm2"),
  leftlabs = c("Study", "Drug", "Dose", "N", "Mean","SD", "Drug", "Dose", "N", "Mean", "SD"),
  fontsize = 9,
  col.square = "#000080",
  col.diamond = "#000080",
  col.predict = "gray",
  fontfamily = "Arial",
  colgap.forest = "2cm",
  xlim = c(-4.5, 2),
  label.left = "Favors intervention",
  label.right = "Favors control",
  smlab = "SMD"
)


dev.off()
```


### Publication Bias Assessment

We assess potential publication bias using both visual (funnel plot) and statistical (Egger's test) methods.

```{r eggertest}
# Run Egger's test
eggers.test(main_results$model.overall)
```
Egger's test did not indicate small-study effects/publication bias.


```{r funnelplot, message=FALSE, results='hide'}
png(filename = file.path(basedir, "analysis/mdmaptsd/paperfigs/SI_Fig_01.png"), res = 315, width = 2500, height = 1500)
funnel(main_results$model.overall,
  studlab = TRUE, # can also use vector with study labels
  cex.studlab = 0.7, # adjust size of study labels
  cex = 0.7, # axis tick labels and point size
  cex.axis = 0.7, # axis number label size
  cex.lab = 0.7, # axis title (xlab, ylab) size
  cex.main = 0.95, # main title size
  xlim = c(-3, 0.2),
  col = "steelblue",
  pch = 19, # bold solid circle
  bg = "white",
  xlab = "Standardized Mean Difference (SMD)",
  ylab = "Standard Error (SE)",
  main = "Funnel Plot of Main Model Continuous Outcomes",
  las = 1
)
dev.off()
```

![](/analysis/mdmaptsd/paperfigs/SI_Fig_01.png)
Visual inspection of the funnel plot reveals limited asymmetry, and the Egger's test did not find small study effects, implying minimal evidence of publication bias.



### Three-level correlated and hierarchical effects (CHE) meta-analysis

We conduct a three-level correlated and hierarchical effects (CHE) meta-analysis to examine how the effect of MDMA changes over time.
This approach accounts for the hierarchical structure of the data (multiple timepoints within studies) and potential correlations between timepoints.

```{r che, message=FALSE}
# Select data for the CHE meta-analysis
data_time$dose_arm1 <- as.numeric(gsub("mg", "", data_time$dose_arm1))
time_results <- runMetaAnalysis(data_time,
  which.run = "threelevel.che",
  # Specify statistical parameters
  es.measure = "g", # Hedges' g
  method.tau = "REML",
  method.tau.ci = "Q-Profile", # N/A for three-level models
  # i2.ci.boot = TRUE, # Need to use bootstrapping to get het. CI on three-level
  hakn = TRUE, # Knapp-Hartung adjustment

  # Specify variables
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "dose_days",
  round.digits = 2
)

plot(
  time_results, 
  which = "threelevel.che"
)
```

```{r save plot}
png(filename = file.path(basedir, "analysis/mdmaptsd/paperfigs/three_level_regression_forest.png"), res = 315, width = 4500, height = 1500)
plot(
  time_results, 
  which = "threelevel.che",
  leftcols = c("studlab", "n_dosing_sessions", "dose_arm1", "cumulative_dose_arm1","dose_weeks"),
  leftlabs = c("Study", "Dosing Session", "Dose (mg)", "Cumulative Dose (mg)","Time (weeks)"),
  )
dev.off()
```

The three-level CHE model reveals an overall significant decrease in PTSD scores under MDMA compared to control conditions.

#### Meta-Regression

We perform meta-regression to examine the relationship between time since final dose and treatment effect.

```{r meta-regression n_dosing_sessions, message=FALSE, warning=FALSE}
reg <- metaRegression(time_results$model.threelevel.che, ~n_dosing_sessions)
reg
```

```{r plot-meta-regression, message=FALSE, warning=FALSE, results=FALSE}
png(filename = file.path(basedir, "analysis/mdmaptsd/paperfigs/dosing_sessions_regression.png"), res = 315, width = 3000, height = 2200)
regplot(reg, mod = "n_dosing_sessions", xlab = "Number of dosing sessions", ylab = "Hedges' g")
dev.off()
```

```{r meta-regression cumulative, message=FALSE, warning=FALSE}
reg <- metaRegression(time_results$model.threelevel.che, ~cumulative_dose_arm1)
reg
```

```{r plot-meta-regression, message=FALSE, warning=FALSE, results=FALSE}
png(filename = file.path(basedir, "analysis/mdmaptsd/paperfigs/cumulative_dose.png"), res = 315, width = 3000, height = 2200)
regplot(reg, mod = "cumulative_dose_arm1", xlab = "cumulative dose (sessions x mg)", ylab = "Hedges' g")
dev.off()
```


![](/analysis/mdmaptsd/paperfigs/SI_Fig_03.png)
Adding time since final dose as a continuous predictor to our model reveals a large and significant effect-size favoring MDMA immediately following dosing that was stable over time.

### Sensitivity Analyses

We conduct comprehensive subgroup and sensitivity analyses to examine the robustness of our findings and explore potential moderators of treatment effects.

These analyses include:


**Sensitivity Analyses:**

- In the multi-arm studies (Mithoefer 2018 and Ot'alora 2018) replace high-dose intervention with medium-dose intervention

- Fixed-effects model

```{r subgroup-and-sensitivity-data-filtering}
# Build a dataframe for each subgroup and sensitivity analysis

data_sens <- data %>%
  filterPoolingData(
    primary_instrument == "1",
    primary_timepoint == "1",
    is.na(post_crossover) | !Detect(post_crossover, "1"),
    outcome_type == "msd",
    !(Detect(study, "Mithoefer 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "75 mg")),
    !(Detect(study, "Mithoefer 2018") & (Detect(multi_arm1, "125 mg") & !is.na(multi_arm2))),
    !(Detect(study, "Ot'alora 2018") & (!is.na(multi_arm1)) & Detect(multi_arm2, "100 mg")),
    !(Detect(study, "Ot'alora 2018") & (Detect(multi_arm1, "125 mg") & !is.na(multi_arm2)))
  )
```

Now we can use `metapsyTools` for quickly looking at subgroup and sensitivity results.

```{r run individual meta analyses for paper, warning=FALSE, message=FALSE}
# Run the main "overall" model for comparison

main <- runMetaAnalysis(data_main,

  # Specify statistical parameters
  which.run = "overall", # inverse variance random effects
  es.measure = "g", # Hedges' g
  method.tau = "REML",
  method.tau.ci = "Q-Profile",
  hakn = TRUE, # Knapp-Hartung adjustment

  # Specify variables
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2
)

# Use metapsyTools' replacement and rerun functions for quickly changing parameters

sens <- main # copy the main model
data(sens) <- data_sens # replace the dataframe in the new model
sense <- rerun(sens) # re-run the model
sens

fixed <- main
method.tau(fixed) <- "FE" # for this sensitivity analysis, we keep data the same but change parameters
hakn(fixed) <- FALSE
fixed <- rerun(fixed)
fixed
```


### Dichotomous Outcomes Analysis

In addition to continuous PTSD severity scores, we also analyze dichotomous outcomes including response and remission rates.
These analyses provide complementary information about the clinical significance of MDMA treatment.

#### Response Rate Analysis

We first analyze response rates, defined as the proportion of participants achieving a clinically meaningful reduction in PTSD symptoms.

```{r response model, message=FALSE}
# Get response data

data_response <- data_response[order(data_response$year), ]

# Run meta-analysis

response_results <- runMetaAnalysis(data_response,
  which.run = "overall",
  es.measure = "RR", # risk ratio
  es.type = "raw",
  method.tau = "PM",
  method.tau.ci = "Q-Profile",
  # method.random.ci = "HK", # causes error in new mpT XXXXX
  hakn = TRUE, # Knapp-Hartung adjustement

  # Specify variables
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2
)

summary(response_results$model.overall)
# Create simple forest plot of response results

meta::forest(
  response_results$model.overall,
  sortvar = response_results$model.overall$data$year,
  xlab = "Log RR (95% CI)",
  leftlabs = c("Study", "Log RR"),
  layout = "JAMA"
)
```

Our meta-analysis shows statistically significant greater treatment response with MDMA compared to control conditions.


#### Remission Rate Analysis

We also analyze remission rates, defined as the proportion of participants achieving full remission of depressive symptoms.

```{r remission model, message=FALSE}
# Get remission data

data_remission <- data_remission[order(data_remission$year), ]

# Run meta-analysis

remission_results <- runMetaAnalysis(data_remission,
  which.run = "overall",
  es.measure = "RR", # risk ratio
  es.type = "raw",
  method.tau = "PM",
  method.tau.ci = "Q-Profile",
  # method.random.ci = "HK", # causes error in new mpT XXXXXXX
  hakn = TRUE, # Knapp-Hartung adjustement

  # Specify variables
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_weeks",
  round.digits = 2
)

# Create simple forest plot of remission results

meta::forest(
  remission_results$model.overall,
  sortvar = remission_results$model.overall$data$year,
  xlab = "Log RR (95% CI)",
  leftlabs = c("Study", "Log RR"),
  layout = "JAMA"
)
```

Our meta-analysis shows statistically significant higher remission rates with MDMA compared to control conditions.

```{r forest meta response for indesign, include=FALSE}
### forest plot for response

# grab heterogeneity values
tau2 <- response_results$model.overall$tau2
lower_tau2 <- response_results$model.overall$lower.tau2
upper_tau2 <- response_results$model.overall$upper.tau2
I2 <- response_results$model.overall$I2
lower_I2 <- response_results$model.overall$lower.I2
upper_I2 <- response_results$model.overall$upper.I2
pval <- response_results$model.overall$pval.Q

# format heterogeneity text
heterogeneity_text <- sprintf(
  "Heterogeneity: I² = %.2f%% [%.2f%%, %.2f%%], τ² = %.2f [%.2f, %.2f], p = %.3f",
  I2 * 100, lower_I2 * 100, upper_I2 * 100,
  tau2, lower_tau2, upper_tau2,
  pval
)

png(filename = file.path(basedir, "analysis/mdmaptsd/paperfigs/response_forest_plot_meta_mdmaptsd.png"), res = 315, width = 4500, height = 1500)


meta::forest(response_results$model.overall,
  sortvar = response_results$mode.overall$data$year,
  leftcols = c("studlab", "dose_arm1", "condition_arm1", "event_arm1", "totaln_arm1", "dose_arm2", "condition_arm2", "event_arm2", "totaln_arm2"),
  leftlabs = c("Study", "Dose", "Drug", "Number of Events", "Total", "Dose", "Drug", "Number of Events", "Total"),
  rightlabs = c("Log RR", "95%-CI", "Weight"),
  fontsize = 9,
  col.square = "#000080",
  col.diamond = "#000080",
  col.predict = "gray",
  fontfamily = "Arial",
  colgap.forest = "2cm",
  xlim = c(0.2, 120),
  label.left = "Favors control",
  label.right = "Favors intervention",
  smlab = "Log Risk Ratio"
)

# add heterogeneity text at the bottom
grid::grid.text(
  label = heterogeneity_text,
  x = 0.5, # Centered horizontally (normalized coordinates)
  y = unit(1.5, "lines"), # Slightly below the plot
  just = "center",
  gp = grid::gpar(fontsize = 9, fontfamily = "Arial")
)

dev.off()
```

```{r forest meta remission for indesign, include=FALSE}
### forest plot for remission

# grab heterogeneity values
tau2 <- remission_results$model.overall$tau2
lower_tau2 <- remission_results$model.overall$lower.tau2
upper_tau2 <- remission_results$model.overall$upper.tau2
I2 <- remission_results$model.overall$I2
lower_I2 <- remission_results$model.overall$lower.I2
upper_I2 <- remission_results$model.overall$upper.I2
pval <- remission_results$model.overall$pval.Q

# format heterogeneity text
heterogeneity_text <- sprintf(
  "Heterogeneity: I² = %.2f%% [%.2f%%, %.2f%%], τ² = %.2f [%.2f, %.2f], p = %.3f",
  I2 * 100, lower_I2 * 100, upper_I2 * 100,
  tau2, lower_tau2, upper_tau2,
  pval
)

png(filename = file.path(basedir, "analysis/mdmaptsd/paperfigs/remission_forest_plot_meta_mdmaptsd.png"), res = 315, width = 4500, height = 1500)


meta::forest(remission_results$model.overall,
  sortvar = remission_results$model.overall$data$year,
  leftcols = c("studlab", "dose_arm1", "condition_arm1", "event_arm1", "totaln_arm1", "dose_arm2", "condition_arm2", "event_arm2", "totaln_arm2"),
  leftlabs = c("Study", "Dose", "Drug", "Number of Events", "Total", "Dose", "Drug", "Number of Events", "Total"),
  rightlabs = c("Log RR", "95%-CI", "Weight"),
  fontsize = 9,
  col.square = "#000080",
  col.diamond = "#000080",
  col.predict = "gray",
  fontfamily = "Arial",
  colgap.forest = "2cm",
  xlim = c(0.2, 55),
  label.left = "Favors control",
  label.right = "Favors intervention",
  smlab = "Log Risk Ratio"
)

# add heterogeneity text at the bottom
grid::grid.text(
  label = heterogeneity_text,
  x = 0.5, # Centered horizontally (normalized coordinates)
  y = unit(1.5, "lines"), # Slightly below the plot
  just = "center",
  gp = grid::gpar(fontsize = 9, fontfamily = "Arial")
)

dev.off()
```

As a sensitivity analysis, we also run a fixed-effects meta-analysis on the response and remission results.

```{r fixed-dichotomous, message=FALSE, warning=FALSE}
# Fixed response
method.tau(response_results) <- "FE"
hakn(response_results) <- FALSE
rerun(response_results)

# Fixed remission
method.tau(remission_results) <- "FE"
hakn(remission_results) <- FALSE
rerun(remission_results)
```
```{r runmetaAnalysis on fixed response results, include=FALSE}
# Run fixed meta-analysis

fixed_response_results <- runMetaAnalysis(data_response,
  which.run = "overall",
  es.measure = "RR", # risk ratio
  es.type = "raw",
  method.tau = "FE",
  method.tau.ci = "Q-Profile",
  method.random.ci = "HK",
  hakn = FALSE, # Knapp-Hartung adjustement

  # Specify variables
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "study_time_point",
  round.digits = 2
)
fixed_response_results
```
```{r runmetaAnalysis on fixed remission results, message=FALSE, warning=FALSE, include=FALSE}
# Run fixed meta-analysis

fixed_remission_results <- runMetaAnalysis(data_remission,
  which.run = "overall",
  es.measure = "RR", # risk ratio
  es.type = "raw",
  method.tau = "FE",
  method.tau.ci = "Q-Profile",
  method.random.ci = "HK",
  hakn = FALSE, # Knapp-Hartung adjustement

  # Specify variables
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "study_time_point",
  round.digits = 2
)
fixed_remission_results
```


Our fixed effects models yielded results that were in line with the main model, showing statistically significant higher response and remission rates with MDMA compared to control conditions.

### Secondary outcome - depression

```{r depression model}
# Run meta-analysis

dep_results <- runMetaAnalysis(data_depression,
  which.run = c("overall"),
  # Specify statistical parameters
  es.measure = "g", # Hedges' g
  method.tau = "REML",
  method.tau.ci = "Q-Profile", # N/A for three-level models
  # i2.ci.boot = TRUE, # Need to use bootstrapping to get het. CI on three-level
  hakn = TRUE, # Knapp-Hartung adjustment

  # Specify variables
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_days",
  round.digits = 2
)

summary(dep_results$model.overall)

# Create simple forest plot of results

plot(
  dep_results,
  which = "overall"
)
```


```{r depression continuous forest plot for indesign, include=FALSE}
png(filename = file.path(basedir, "analysis/mdmaptsd/paperfigs/depression_mdmaptsd.png"), res = 315, width = 4500, height = 1500)

# plot(
#   main_results,
#   which = "overall",
#   leftcols = c("studlab", "condition_arm1", "dose_arm1", "n_arm1", "mean_arm1", "sd_arm1", "condition_arm2", "dose_arm2", "n_arm2", "mean_arm2", "sd_arm2"),
#   leftlabs = c("Study", "Drug", "Dose", "N", "Mean","SD", "Drug", "Dose", "N", "Mean", "SD"),
#   fontsize = 9,
#   col.square = "#000080",
#   col.diamond = "#000080",
#   col.predict = "gray",
#   fontfamily = "Arial",
#   colgap.forest = "2cm",
#   xlim = c(-4.5, 2),
#   label.left = "Favors intervention",
#   label.right = "Favors control",
#   smlab = "SMD")
meta::forest(dep_results$model.overall,
  sortvar = dep_results$model.overall$data$year,
  leftcols = c("studlab", "condition_arm1", "dose_arm1", "n_arm1", "mean_arm1", "sd_arm1", "condition_arm2", "dose_arm2", "n_arm2", "mean_arm2", "sd_arm2"),
  leftlabs = c("Study", "Drug", "Dose", "N", "Mean","SD", "Drug", "Dose", "N", "Mean", "SD"),
  fontsize = 9,
  col.square = "#000080",
  col.diamond = "#000080",
  col.predict = "gray",
  fontfamily = "Arial",
  colgap.forest = "2cm",
  xlim = c(-4.5, 2),
  label.left = "Favors intervention",
  label.right = "Favors control",
  smlab = "SMD"
)


dev.off()
```

As a sensitivity analyses, for the studies that had three arms (Mithoefer 2018 & Ot'aloraG 2018), we replaced the high dose vs. low dose comparisons with medium dose vs. low dose comparisons.

# Medium vs. low dose

```{r primary-meta-analysis, message=FALSE}
# Run meta-analysis

medium_dose_results <- runMetaAnalysis(data_medium_dose,
  which.run = c("overall"),
  # Specify statistical parameters
  es.measure = "g", # Hedges' g
  method.tau = "REML",
  method.tau.ci = "Q-Profile", # N/A for three-level models
  # i2.ci.boot = TRUE, # Need to use bootstrapping to get het. CI on three-level
  hakn = TRUE, # Knapp-Hartung adjustment

  # Specify variables
  study.var = "study",
  arm.var.1 = "condition_arm1",
  arm.var.2 = "condition_arm2",
  measure.var = "instrument",
  w1.var = "n_arm1",
  w2.var = "n_arm2",
  time.var = "time_days",
  round.digits = 2
)

summary(medium_dose_results$model.overall)

# Create simple forest plot of results

plot(
  medium_dose_results,
  which = "overall"
)
```

```{r main continuous forest plot for indesign, include=FALSE}
png(filename = file.path(basedir, "analysis/mdmaptsd/paperfigs/medium_dose_mdmaptsd.png"), res = 315, width = 4500, height = 1500)

# plot(
#   main_results,
#   which = "overall",
#   leftcols = c("studlab", "condition_arm1", "dose_arm1", "n_arm1", "mean_arm1", "sd_arm1", "condition_arm2", "dose_arm2", "n_arm2", "mean_arm2", "sd_arm2"),
#   leftlabs = c("Study", "Drug", "Dose", "N", "Mean","SD", "Drug", "Dose", "N", "Mean", "SD"),
#   fontsize = 9,
#   col.square = "#000080",
#   col.diamond = "#000080",
#   col.predict = "gray",
#   fontfamily = "Arial",
#   colgap.forest = "2cm",
#   xlim = c(-4.5, 2),
#   label.left = "Favors intervention",
#   label.right = "Favors control",
#   smlab = "SMD")
meta::forest(medium_dose_results$model.overall,
  sortvar = medium_dose_results$model.overall$data$year,
  leftcols = c("studlab", "condition_arm1", "dose_arm1", "n_arm1", "mean_arm1", "sd_arm1", "condition_arm2", "dose_arm2", "n_arm2", "mean_arm2", "sd_arm2"),
  leftlabs = c("Study", "Drug", "Dose", "N", "Mean","SD", "Drug", "Dose", "N", "Mean", "SD"),
  fontsize = 9,
  col.square = "#000080",
  col.diamond = "#000080",
  col.predict = "gray",
  fontfamily = "Arial",
  colgap.forest = "2cm",
  xlim = c(-4.5, 2),
  label.left = "Favors intervention",
  label.right = "Favors control",
  smlab = "SMD"
)


dev.off()
```



```{r calculating n for each study at timepoint, include=FALSE}
# Create function to get total n at each timepoint

total_n <- function(df) {
  total <- sum(df$n_arm1 + df$n_arm2, na.rm = TRUE)
  return(total)
}

total_n_dichotomous <- function(df) {
  total <- sum(df$totaln_arm1 + df$totaln_arm2, na.rm = TRUE)
  return(total)
}


# Apply function to different data frames
total_data_main <- total_n(data_main)
print(paste("main n =", total_data_main))

total_data_sens <- total_n(data_sens)
print(paste("sens n =", total_data_sens))

total_data_response <- total_n_dichotomous(data_response)
print(paste("response n =", total_data_response))

total_data_remission <- total_n_dichotomous(data_remission)
print(paste("remission n =", total_data_remission))

total_data_dep <- total_n(data_depression)
print(paste("dep n =", total_data_dep))
```

### Summary and Conclusions

This comprehensive meta-analysis provides promising evidence regarding the efficacy of MDMA for treating PTSD, but should be interpreted with caution.

The analysis includes:

1. **Primary analysis** of continuous PTSD severity outcomes using standardized mean differences
2. **Time course analysis** examining how treatment effects evolve over time
3. **Publication bias assessment** using multiple methods
4. **Extensive subgroup and sensitivity analyses** to examine robustness and moderators
5. **Dichotomous outcomes analysis** of response and remission rates

The results demonstrate consistent evidence for the efficacy of MDMA in reducing PTSD severity, with effects persisting over time and showing robustness across various sensitivity analyses.
However, given the small number of studies eligible to include in our meta-analysis and limitations such as the potential for functional unblinding and expectancy effects, results should be interpreted with caution.

